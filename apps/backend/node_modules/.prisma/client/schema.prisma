// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================================================
// ENUMS - Following Enterprise Standards (Union Types in TypeScript)
// ===================================================================

enum UserRole {
  OPERATOR
  MANAGER
  ADMIN
  QUALITY_ASSURANCE // GxP: Required for pharmaceutical compliance
}

enum ProductionLineStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

enum ProcessStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  WAITING
  CANCELLED
}

// ===================================================================
// USER MODEL - Authentication and Authorization
// ===================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String // Hashed with bcrypt
  firstName String?
  lastName  String?
  role      UserRole @default(OPERATOR)
  isActive  Boolean  @default(true)

  // Enterprise: Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // GxP: Relationships for audit trail
  auditLogs              AuditLog[]       @relation("AuditLogUser")
  createdProductionLines ProductionLine[] @relation("ProductionLineCreatedBy")
  createdProcesses       Process[]        @relation("ProcessCreatedBy")

  // GxP: Versioning relationships
  productionLineVersionsCreated ProductionLineVersion[] @relation("ProductionLineVersionCreatedBy")
  processVersionsCreated        ProcessVersion[]        @relation("ProcessVersionCreatedBy")

  @@map("users")
}

// ===================================================================
// PRODUCTION LINE MODEL - Main manufacturing lines
// ===================================================================

model ProductionLine {
  id     String               @id @default(cuid())
  name   String
  status ProductionLineStatus @default(ACTIVE)

  // GxP: Versioning support for data integrity
  version  Int     @default(1)
  isActive Boolean @default(true)
  parentId String? // For versioning chain - references previous version

  // Enterprise: Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  reason    String // GxP: Mandatory "Why" for all changes

  // Relationships
  creator   User                    @relation("ProductionLineCreatedBy", fields: [createdBy], references: [id])
  processes Process[]
  versions  ProductionLineVersion[] @relation("ProductionLineEntity")

  @@map("production_lines")
}

// ===================================================================
// PROCESS MODEL - Individual manufacturing processes
// ===================================================================

model Process {
  id          String        @id @default(cuid())
  title       String
  description String?
  duration    Int? // Duration in minutes
  progress    Float         @default(0.0) // Progress percentage (0.0 to 1.0)
  status      ProcessStatus @default(PENDING)

  // UI positioning (for visual workflow)
  x     Float  @default(0.0)
  y     Float  @default(0.0)
  color String @default("#4F46E5") // Default color

  // GxP: Versioning support
  version  Int     @default(1)
  isActive Boolean @default(true)
  parentId String? // For versioning chain

  // Foreign keys
  productionLineId String

  // Enterprise: Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  reason    String // GxP: Mandatory "Why" for all changes

  // Relationships
  productionLine ProductionLine   @relation(fields: [productionLineId], references: [id], onDelete: Cascade)
  creator        User             @relation("ProcessCreatedBy", fields: [createdBy], references: [id])
  versions       ProcessVersion[] @relation("ProcessEntity")

  @@map("processes")
}

// ===================================================================
// AUDIT LOG MODEL - Complete audit trail for GxP compliance
// ===================================================================

model AuditLog {
  id     String @id @default(cuid())
  userId String
  action String // CREATE, UPDATE, DELETE, APPROVE, REJECT, etc.

  // Entity information
  entityType String // ProductionLine, Process, User, etc.
  entityId   String

  // Change details
  details Json? // Previous and new values
  reason  String? // GxP: "Why" this change was made

  // Request context
  ipAddress String?
  userAgent String?

  // Enterprise: Audit fields
  createdAt DateTime @default(now())

  // Relationships
  user User @relation("AuditLogUser", fields: [userId], references: [id])

  @@map("audit_logs")
}

// ===================================================================
// GXP VERSIONING MODELS - Immutable historical records
// ===================================================================

model ProductionLineVersion {
  id       String @id @default(cuid())
  entityId String // References ProductionLine.id
  version  Int

  // Snapshot of ProductionLine data at this version
  name   String
  status ProductionLineStatus

  // Enterprise: Audit fields (immutable)
  createdAt DateTime @default(now())
  createdBy String
  reason    String // GxP: Mandatory "Why" for this version

  // Relationships
  entity  ProductionLine @relation("ProductionLineEntity", fields: [entityId], references: [id], onDelete: Cascade)
  creator User           @relation("ProductionLineVersionCreatedBy", fields: [createdBy], references: [id])

  // GxP: Ensure unique versioning
  @@unique([entityId, version])
  @@map("production_line_versions")
}

model ProcessVersion {
  id       String @id @default(cuid())
  entityId String // References Process.id
  version  Int

  // Snapshot of Process data at this version
  title            String
  description      String?
  duration         Int?
  progress         Float
  status           ProcessStatus
  x                Float
  y                Float
  color            String
  productionLineId String

  // Enterprise: Audit fields (immutable)
  createdAt DateTime @default(now())
  createdBy String
  reason    String // GxP: Mandatory "Why" for this version

  // Relationships
  entity  Process @relation("ProcessEntity", fields: [entityId], references: [id], onDelete: Cascade)
  creator User    @relation("ProcessVersionCreatedBy", fields: [createdBy], references: [id])

  // GxP: Ensure unique versioning
  @@unique([entityId, version])
  @@map("process_versions")
}
